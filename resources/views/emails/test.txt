#include <ESP32Servo.h>
#include <WiFi.h>
#include <WebServer.h>
#include <time.h>

// ===== PIN DEFINITIONS =====
#define WATER_SENSOR 27
#define RELAY_PIN    26
#define SERVO_PIN    14
#define A7670E_RX    16
#define A7670E_TX    17
#define A7670E_PWR   25

// ===== WIFI CREDENTIALS =====
const char* ssid = "TestingWifi";
const char* password = "Abc1234567";

// ===== SERIAL PORT =====
HardwareSerial a7670e(1);
Servo myServo;
WebServer server(80);

// ===== CONFIGURATION =====
String phoneNumber = "+639070653250";

// ===== LOGIC VARIABLES =====
bool triggered = false;
bool pumpRunning = false;
bool servoRunning = false;
bool smsSent = false;
unsigned long pumpStartTime = 0;
unsigned long servoStartTime = 0;
const unsigned long PUMP_DURATION = 10000;

// ===== LOCATION & TIME VARIABLES =====
String latStr = "";
String lngStr = "";
String timeStr = "";
bool locationSet = false;

// ===== GET PHILIPPINE TIME FROM NTP =====
String getPhilippineTime() {
  configTime(8 * 3600, 0, "pool.ntp.org");
  
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo, 5000)) {
    return "Time sync failed";
  }
  
  char buf[50];
  strftime(buf, sizeof(buf), "%b %d, %Y %H:%M:%S PHT", &timeinfo);
  return String(buf);
}

// ===== WEB PAGES =====
String getIndexPage() {
  String html = "<!DOCTYPE html><html><head>";
  html += "<meta name='viewport' content='width=device-width, initial-scale=1'>";
  html += "<title>Flood Detection System</title>";
  html += "<style>";
  html += "body { font-family: Arial; margin: 20px; background: #f0f0f0; }";
  html += ".container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }";
  html += "h1 { color: #2196F3; text-align: center; }";
  html += ".status { padding: 15px; margin: 10px 0; border-radius: 5px; }";
  html += ".success { background: #4CAF50; color: white; }";
  html += ".warning { background: #ff9800; color: white; }";
  html += ".info { background: #2196F3; color: white; }";
  html += "button { width: 100%; padding: 15px; font-size: 16px; margin: 5px 0; border: none; border-radius: 5px; cursor: pointer; }";
  html += ".btn-primary { background: #2196F3; color: white; }";
  html += ".btn-success { background: #4CAF50; color: white; }";
  html += "input { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }";
  html += "#map { width: 100%; height: 300px; border: 1px solid #ccc; margin: 10px 0; }";
  html += "</style>";
  html += "</head><body>";
  html += "<div class='container'>";
  html += "<h1>üåä Flood Detection System</h1>";
  
  if (locationSet) {
    html += "<div class='status success'>‚úÖ Location Set</div>";
    html += "<p><strong>Latitude:</strong> " + latStr + "</p>";
    html += "<p><strong>Longitude:</strong> " + lngStr + "</p>";
    html += "<p><strong>Time:</strong> " + timeStr + "</p>";
  } else {
    html += "<div class='status warning'>‚ö†Ô∏è Location Not Set</div>";
  }
  
  html += "<div class='status info'>";
  html += "<strong>System Status</strong><br>";
  html += "Water: " + String(digitalRead(WATER_SENSOR) == HIGH ? "DETECTED ‚ö†Ô∏è" : "Normal ‚úì") + "<br>";
  html += "Pump: " + String(pumpRunning ? "ON" : "OFF") + "<br>";
  html += "</div>";
  
  html += "<h3>Set Location</h3>";
  html += "<button class='btn-primary' onclick='getLocation()'>üìç Use My Current Location</button>";
  
  html += "<h4>Or Enter Manually:</h4>";
  html += "<form action='/setlocation' method='POST'>";
  html += "<input type='text' name='lat' placeholder='Latitude' required>";
  html += "<input type='text' name='lng' placeholder='Longitude' required>";
  html += "<button type='submit' class='btn-success'>Set Location</button>";
  html += "</form>";
  
  html += "<div id='map'></div>";
  
  html += "<script>";
  html += "function getLocation() {";
  html += "  if (navigator.geolocation) {";
  html += "    navigator.geolocation.getCurrentPosition(function(pos) {";
  html += "      var lat = pos.coords.latitude;";
  html += "      var lng = pos.coords.longitude;";
  html += "      fetch('/setlocation?lat=' + lat + '&lng=' + lng)";
  html += "        .then(() => location.reload());";
  html += "    }, function(error) {";
  html += "      alert('Error getting location: ' + error.message);";
  html += "    });";
  html += "  } else {";
  html += "    alert('Geolocation not supported');";
  html += "  }";
  html += "}";
  
  if (locationSet) {
    html += "var map = L.map('map').setView([" + latStr + ", " + lngStr + "], 15);";
    html += "L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);";
    html += "L.marker([" + latStr + ", " + lngStr + "]).addTo(map).bindPopup('Flood Detection System').openPopup();";
  }
  
  html += "</script>";
  html += "<link rel='stylesheet' href='https://unpkg.com/leaflet@1.7.1/dist/leaflet.css'/>";
  html += "<script src='https://unpkg.com/leaflet@1.7.1/dist/leaflet.js'></script>";
  html += "</div></body></html>";
  
  return html;
}

void handleRoot() {
  server.send(200, "text/html", getIndexPage());
}

void handleSetLocation() {
  if (server.hasArg("lat") && server.hasArg("lng")) {
    latStr = server.arg("lat");
    lngStr = server.arg("lng");
    timeStr = getPhilippineTime();
    locationSet = true;
    
    Serial.println("\n‚úÖ Location set via WiFi:");
    Serial.println("Lat: " + latStr);
    Serial.println("Lng: " + lngStr);
    Serial.println("Time: " + timeStr);
    
    server.sendHeader("Location", "/");
    server.send(303);
  } else {
    server.send(400, "text/plain", "Missing parameters");
  }
}

// ===== HELPER FUNCTION =====
String waitForResponse(int timeout = 2000) {
  String response = "";
  unsigned long start = millis();
  while (millis() - start < timeout) {
    while (a7670e.available()) {
      char c = a7670e.read();
      response += c;
      Serial.write(c);
    }
  }
  Serial.println();
  return response;
}

// ===== POWER ON MODULE =====
void powerOnA7670E() {
  Serial.println("üîå Powering on A7670E...");
  pinMode(A7670E_PWR, OUTPUT);
  digitalWrite(A7670E_PWR, HIGH);
  delay(500);
  digitalWrite(A7670E_PWR, LOW);
  delay(1000);
  digitalWrite(A7670E_PWR, HIGH);
  delay(5000);
}

// ===== SEND SMS =====
void sendSMS(String msg) {
  Serial.println("\n‚û°Ô∏è Sending SMS...");
  
  while (a7670e.available()) a7670e.read();
  delay(500);
  
  a7670e.println("AT");
  waitForResponse(1000);
  
  a7670e.println("AT+CMGF=1");
  waitForResponse(1000);
  
  a7670e.println("AT+CSCS=\"GSM\"");
  waitForResponse(1000);
  
  while (a7670e.available()) a7670e.read();
  
  a7670e.print("AT+CMGS=\"");
  a7670e.print(phoneNumber);
  a7670e.println("\"");
  
  delay(2000);
  
  bool gotPrompt = false;
  unsigned long start = millis();
  while (millis() - start < 5000) {
    if (a7670e.available()) {
      char c = a7670e.read();
      Serial.write(c);
      if (c == '>') {
        gotPrompt = true;
        Serial.println("\n‚úÖ Prompt");
        break;
      }
    }
  }
  
  if (!gotPrompt) {
    Serial.println("‚ùå No prompt!");
    a7670e.write(27);
    return;
  }
  
  delay(500);
  a7670e.print(msg);
  delay(500);
  a7670e.write(26);
  
  Serial.println("üì§ Waiting...");
  String resp = "";
  start = millis();
  while (millis() - start < 30000) {
    while (a7670e.available()) {
      char c = a7670e.read();
      resp += c;
      Serial.write(c);
    }
    if (resp.indexOf("+CMGS:") >= 0) {
      Serial.println("\n‚úÖ SMS SENT!");
      return;
    }
    if (resp.indexOf("ERROR") >= 0) {
      Serial.println("\n‚ùå FAILED!");
      return;
    }
  }
  Serial.println("\n‚ö†Ô∏è Timeout");
}

// ===== SETUP =====
void setup() {
  pinMode(WATER_SENSOR, INPUT);
  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, HIGH);
  
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n========================================");
  Serial.println("  FLOOD DETECTION SYSTEM");
  Serial.println("========================================\n");
  
  // Connect to WiFi - IMPROVED VERSION
  Serial.println("üì∂ Connecting to WiFi...");
  Serial.print("SSID: ");
  Serial.println(ssid);
  
  WiFi.disconnect(true);
  delay(1000);
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 40) {
    delay(500);
    Serial.print(".");
    attempts++;
    
    if (attempts % 10 == 0) {
      Serial.println();
      Serial.print("Status: ");
      Serial.print(WiFi.status());
      Serial.print(" | Attempt: ");
      Serial.print(attempts);
      Serial.println("/40");
    }
  }
  Serial.println();
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\n‚úÖ‚úÖ‚úÖ WiFi Connected! ‚úÖ‚úÖ‚úÖ");
    Serial.print("üì± IP Address: http://");
    Serial.println(WiFi.localIP());
    Serial.print("üì∂ Signal: ");
    Serial.print(WiFi.RSSI());
    Serial.println(" dBm");
    Serial.println("\nüåê OPEN THIS URL ON YOUR PHONE:");
    Serial.print("   http://");
    Serial.println(WiFi.localIP());
    Serial.println();
    
    // Setup web server
    server.on("/", handleRoot);
    server.on("/setlocation", handleSetLocation);
    server.begin();
    Serial.println("‚úÖ Web server started\n");
  } else {
    Serial.println("\n‚ùå WiFi Connection FAILED!");
    Serial.print("Status code: ");
    Serial.println(WiFi.status());
    Serial.println("\nTroubleshooting:");
    Serial.println("1. Make sure phone hotspot 'TestingWifi' is ON");
    Serial.println("2. Password is 'Abc1234567' (case-sensitive)");
    Serial.println("3. Hotspot is 2.4GHz (not 5GHz)");
    Serial.println("4. ESP32 is within 5 meters of phone");
    Serial.println("\nContinuing without web interface...\n");
  }
  
  powerOnA7670E();
  
  Serial.println("\nüì° Initializing A7670E...");
  a7670e.begin(115200, SERIAL_8N1, A7670E_RX, A7670E_TX);
  delay(2000);
  
  a7670e.println("AT");
  waitForResponse(2000);
  
  a7670e.println("ATE0");
  waitForResponse(1000);
  
  Serial.println("\n‚è≥ Network registration...");
  for (int i = 0; i < 40; i++) {
    a7670e.println("AT+CREG?");
    String r = waitForResponse(1000);
    if (r.indexOf("+CREG: 0,1") >= 0 || r.indexOf("+CREG: 0,5") >= 0) {
      Serial.println("‚úÖ Network OK!");
      break;
    }
    if (i % 5 == 0) Serial.printf("Searching %d/40\n", i);
    delay(1000);
  }
  
  a7670e.println("AT+CMGF=1");
  waitForResponse(1000);
  
  Serial.println("\nüîß Servo...");
  myServo.setPeriodHertz(50);
  myServo.attach(SERVO_PIN, 500, 2400);
  myServo.write(0);
  
  Serial.println("\n========================================");
  Serial.println("‚úÖ SYSTEM READY!");
  Serial.println("========================================\n");
}

// ===== LOOP =====
void loop() {
  server.handleClient();
  
  int waterDetected = digitalRead(WATER_SENSOR);
  
  static unsigned long lastPrint = 0;
  if (!triggered && millis() - lastPrint > 10000) {
    Serial.print("üíß ");
    Serial.println(waterDetected == HIGH ? "DETECTED" : "Normal");
    lastPrint = millis();
  }
  
  if (waterDetected == HIGH && !triggered) {
    Serial.println("\nüö® WATER DETECTED!");
    triggered = true;
    pumpRunning = true;
    pumpStartTime = millis();
    
    digitalWrite(RELAY_PIN, LOW);
    Serial.println("üîå Pump ON\n");
  }
  
  if (pumpRunning && millis() - pumpStartTime >= PUMP_DURATION) {
    pumpRunning = false;
    servoRunning = true;
    servoStartTime = millis();
    
    digitalWrite(RELAY_PIN, HIGH);
    Serial.println("üîå Pump OFF");
    Serial.println("üîÑ Servo...\n");
    myServo.write(0);
  }
  
  if (servoRunning) {
    unsigned long e = millis() - servoStartTime;
    
    if (e < 2000) {
      myServo.write(map(e, 0, 2000, 0, 180));
    } else {
      servoRunning = false;
      myServo.write(0);
      Serial.println("‚úÖ Servo done\n");
      
      if (WiFi.status() == WL_CONNECTED) {
        timeStr = getPhilippineTime();
      }
      
      String sms = "FLOOD ALERT!\n";
      sms += "Harness sensor detected water\n";
      sms += "Inflation: 10s\n";
      sms += "Status: UNSAFE\n";
      sms += "Time: " + (timeStr != "" ? timeStr : "Not set") + "\n";
      
      if (locationSet && latStr != "" && lngStr != "") {
        sms += "Location: https://maps.google.com/?q=" + latStr + "," + lngStr;
      } else {
        sms += "Location: Not set (use web interface)";
      }
      
      Serial.println("üì± SMS:");
      Serial.println("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
      Serial.println(sms);
      Serial.println("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n");
      
      sendSMS(sms);
      
      smsSent = true;
      Serial.println("‚úÖ COMPLETE!\n");
    }
  }
  
  if (triggered && smsSent && waterDetected == LOW) {
    triggered = false;
    pumpRunning = false;
    servoRunning = false;
    smsSent = false;
    
    Serial.println("üíö Reset\n");
  }
  
  delay(50);
}