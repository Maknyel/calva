#include <ESP32Servo.h>

// ===== PIN DEFINITIONS =====
#define WATER_SENSOR 27
#define RELAY_PIN    26
#define SERVO_PIN    14
#define A7670E_RX    16
#define A7670E_TX    17
#define A7670E_PWR   25

// ===== SERIAL PORT =====
HardwareSerial a7670e(1);
Servo myServo;

// ===== CONFIGURATION =====
String phoneNumber = "+639070653250";

// ===== LOGIC VARIABLES =====
bool triggered = false;
bool pumpRunning = false;
bool servoRunning = false;
bool smsSent = false;
unsigned long pumpStartTime = 0;
unsigned long servoStartTime = 0;
const unsigned long PUMP_DURATION = 10000;

// ===== GPS VARIABLES =====
String latStr = "";
String lngStr = "";
String timeStr = "";

// ===== HELPER FUNCTION =====
String waitForResponse(int timeout = 2000) {
  String response = "";
  unsigned long start = millis();
  while (millis() - start < timeout) {
    while (a7670e.available()) {
      char c = a7670e.read();
      response += c;
      Serial.write(c);
    }
  }
  Serial.println();
  return response;
}

// ===== FORMAT GPS TIME TO PHILIPPINE TIME =====
String formatGPSTime(String utc) {
  if (utc.length() < 14) return "";
  
  String year = utc.substring(0, 4);
  String month = utc.substring(4, 6);
  String day = utc.substring(6, 8);
  String hour = utc.substring(8, 10);
  String minute = utc.substring(10, 12);
  String second = utc.substring(12, 14);
  
  int hr = hour.toInt() + 8;  // UTC+8 for Philippines
  int dy = day.toInt();
  
  if (hr >= 24) {
    hr -= 24;
    dy++;
  }
  
  String months[] = {"Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"};
  int mn = month.toInt() - 1;
  String monthName = (mn >= 0 && mn < 12) ? months[mn] : month;
  
  char buf[50];
  sprintf(buf, "%s %02d, %s %02d:%s:%s PHT", 
          monthName.c_str(), dy, year.c_str(), hr, minute.c_str(), second.c_str());
  
  return String(buf);
}

// ===== POWER ON MODULE =====
void powerOnA7670E() {
  Serial.println("üîå Powering on A7670E...");
  pinMode(A7670E_PWR, OUTPUT);
  digitalWrite(A7670E_PWR, HIGH);
  delay(500);
  digitalWrite(A7670E_PWR, LOW);
  delay(1000);
  digitalWrite(A7670E_PWR, HIGH);
  delay(5000);
}

// ===== INITIALIZE GPS PROPERLY =====
bool initGPS() {
  Serial.println("\nüõ∞Ô∏è Initializing GPS...");
  
  // Method 1: Try AT+CGNSPWR
  Serial.println("Method 1: AT+CGNSPWR=1");
  a7670e.println("AT+CGNSPWR=1");
  String r1 = waitForResponse(2000);
  
  if (r1.indexOf("OK") >= 0) {
    Serial.println("‚úÖ GPS powered on with AT+CGNSPWR");
    delay(2000);
    return true;
  }
  
  // Method 2: Try AT+CGPS
  Serial.println("Method 2: AT+CGPS=1");
  a7670e.println("AT+CGPS=1");
  String r2 = waitForResponse(2000);
  
  if (r2.indexOf("OK") >= 0) {
    Serial.println("‚úÖ GPS powered on with AT+CGPS");
    delay(2000);
    return true;
  }
  
  // Method 3: Try AT+CGPSINFO
  Serial.println("Method 3: Checking AT+CGPSINFO");
  a7670e.println("AT+CGPSINFO=1");
  String r3 = waitForResponse(2000);
  
  Serial.println("\n‚ùå GPS initialization failed!");
  Serial.println("Your board may not have GPS hardware.");
  Serial.println("Response 1: " + r1);
  Serial.println("Response 2: " + r2);
  Serial.println("Response 3: " + r3);
  
  return false;
}

// ===== GET GPS LOCATION =====
bool getGPSLocation() {
  Serial.println("\nüõ∞Ô∏è Getting GPS fix (must be OUTDOORS)...");
  
  for (int i = 0; i < 60; i++) {  // 60 attempts = ~2 minutes
    Serial.printf("Attempt %d/60...\n", i + 1);
    
    // Try AT+CGNSINF
    a7670e.println("AT+CGNSINF");
    String resp = waitForResponse(2000);
    
    if (resp.indexOf("+CGNSINF:") >= 0) {
      int p = resp.indexOf("+CGNSINF:");
      String data = resp.substring(p + 10);
      
      // Parse: runStatus,fixStatus,UTC,lat,lon,...
      int c1 = data.indexOf(',');
      int c2 = data.indexOf(',', c1 + 1);
      int c3 = data.indexOf(',', c2 + 1);
      int c4 = data.indexOf(',', c3 + 1);
      int c5 = data.indexOf(',', c4 + 1);
      
      if (c5 > 0) {
        String fix = data.substring(c1 + 1, c2);
        String utc = data.substring(c2 + 1, c3);
        String lat = data.substring(c3 + 1, c4);
        String lon = data.substring(c4 + 1, c5);
        
        fix.trim();
        utc.trim();
        lat.trim();
        lon.trim();
        
        Serial.println("Fix status: " + fix + ", Lat: " + lat + ", Lon: " + lon);
        
        if (fix == "1" && lat != "0.0" && lon != "0.0" && lat.length() > 0) {
          latStr = lat;
          lngStr = lon;
          timeStr = formatGPSTime(utc);
          
          Serial.println("‚úÖ GPS FIX ACQUIRED!");
          Serial.println("Lat: " + latStr);
          Serial.println("Lon: " + lngStr);
          Serial.println("Time: " + timeStr);
          return true;
        }
      }
    } else if (resp.indexOf("ERROR") >= 0) {
      Serial.println("‚ùå AT+CGNSINF returned ERROR - GPS not available on this board");
      return false;
    }
    
    delay(2000);
  }
  
  Serial.println("‚ùå No GPS fix after 2 minutes");
  return false;
}

// ===== SEND SMS =====
void sendSMS(String msg) {
  Serial.println("\n‚û°Ô∏è Sending SMS...");
  
  while (a7670e.available()) a7670e.read();
  delay(500);
  
  a7670e.println("AT");
  waitForResponse(1000);
  
  a7670e.println("AT+CMGF=1");
  waitForResponse(1000);
  
  a7670e.println("AT+CSCS=\"GSM\"");
  waitForResponse(1000);
  
  while (a7670e.available()) a7670e.read();
  
  a7670e.print("AT+CMGS=\"");
  a7670e.print(phoneNumber);
  a7670e.println("\"");
  
  delay(2000);
  
  bool gotPrompt = false;
  unsigned long start = millis();
  while (millis() - start < 5000) {
    if (a7670e.available()) {
      char c = a7670e.read();
      Serial.write(c);
      if (c == '>') {
        gotPrompt = true;
        Serial.println("\n‚úÖ Prompt");
        break;
      }
    }
  }
  
  if (!gotPrompt) {
    Serial.println("‚ùå No prompt!");
    a7670e.write(27);
    return;
  }
  
  delay(500);
  a7670e.print(msg);
  delay(500);
  a7670e.write(26);
  
  Serial.println("üì§ Waiting...");
  String resp = "";
  start = millis();
  while (millis() - start < 30000) {
    while (a7670e.available()) {
      char c = a7670e.read();
      resp += c;
      Serial.write(c);
    }
    if (resp.indexOf("+CMGS:") >= 0) {
      Serial.println("\n‚úÖ SMS SENT!");
      return;
    }
    if (resp.indexOf("ERROR") >= 0) {
      Serial.println("\n‚ùå FAILED!");
      return;
    }
  }
  Serial.println("\n‚ö†Ô∏è Timeout");
}

// ===== SETUP =====
void setup() {
  pinMode(WATER_SENSOR, INPUT);
  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, HIGH);
  
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n========================================");
  Serial.println("  FLOOD DETECTION SYSTEM");
  Serial.println("========================================\n");
  
  powerOnA7670E();
  
  Serial.println("üì° Initializing A7670E...");
  a7670e.begin(115200, SERIAL_8N1, A7670E_RX, A7670E_TX);
  delay(2000);
  
  a7670e.println("AT");
  waitForResponse(2000);
  
  a7670e.println("ATE0");
  waitForResponse(1000);
  
  a7670e.println("ATI");
  waitForResponse(2000);
  
  Serial.println("\n‚è≥ Network registration...");
  for (int i = 0; i < 40; i++) {
    a7670e.println("AT+CREG?");
    String r = waitForResponse(1000);
    if (r.indexOf("+CREG: 0,1") >= 0 || r.indexOf("+CREG: 0,5") >= 0) {
      Serial.println("‚úÖ Network OK!");
      break;
    }
    if (i % 5 == 0) Serial.printf("Searching %d/40\n", i);
    delay(1000);
  }
  
  a7670e.println("AT+CSQ");
  waitForResponse(2000);
  
  a7670e.println("AT+CMGF=1");
  waitForResponse(1000);
  
  // Try to initialize GPS
  bool hasGPS = initGPS();
  
  if (hasGPS) {
    Serial.println("‚úÖ GPS available - will get location when triggered");
  } else {
    Serial.println("‚ö†Ô∏è GPS NOT available - SMS will send without location");
  }
  
  Serial.println("\nüîß Servo...");
  myServo.setPeriodHertz(50);
  myServo.attach(SERVO_PIN, 500, 2400);
  myServo.write(0);
  
  Serial.println("\n========================================");
  Serial.println("‚úÖ READY!");
  Serial.println("========================================\n");
}

// ===== LOOP =====
void loop() {
  int waterDetected = digitalRead(WATER_SENSOR);
  
  static unsigned long lastPrint = 0;
  if (!triggered && millis() - lastPrint > 10000) {
    Serial.print("üíß ");
    Serial.println(waterDetected == HIGH ? "DETECTED" : "Normal");
    lastPrint = millis();
  }
  
  if (waterDetected == HIGH && !triggered) {
    Serial.println("\nüö® WATER DETECTED!");
    triggered = true;
    pumpRunning = true;
    pumpStartTime = millis();
    
    digitalWrite(RELAY_PIN, LOW);
    Serial.println("üîå Pump ON\n");
  }
  
  if (pumpRunning && millis() - pumpStartTime >= PUMP_DURATION) {
    pumpRunning = false;
    servoRunning = true;
    servoStartTime = millis();
    
    digitalWrite(RELAY_PIN, HIGH);
    Serial.println("üîå Pump OFF");
    Serial.println("üîÑ Servo...\n");
    myServo.write(0);
  }
  
  if (servoRunning) {
    unsigned long e = millis() - servoStartTime;
    
    if (e < 2000) {
      myServo.write(map(e, 0, 2000, 0, 180));
    } else {
      servoRunning = false;
      myServo.write(0);
      Serial.println("‚úÖ Servo done\n");
      
      // Try GPS (2 minute max)
      bool gotGPS = getGPSLocation();
      
      String sms = "FLOOD ALERT!\n";
      sms += "Harness sensor detected water\n";
      sms += "Inflation: 10s\n";
      sms += "Status: UNSAFE\n";
      
      if (gotGPS && timeStr != "") {
        sms += "Time: " + timeStr + "\n";
      } else {
        sms += "Time: GPS time unavailable\n";
      }
      
      if (gotGPS && latStr != "" && lngStr != "") {
        sms += "Location: https://maps.google.com/?q=" + latStr + "," + lngStr;
      } else {
        sms += "Location: GPS fix failed (needs outdoors + clear sky)";
      }
      
      Serial.println("üì± SMS:");
      Serial.println("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
      Serial.println(sms);
      Serial.println("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n");
      
      sendSMS(sms);
      
      smsSent = true;
      Serial.println("‚úÖ COMPLETE!\n");
    }
  }
  
  if (triggered && smsSent && waterDetected == LOW) {
    triggered = false;
    pumpRunning = false;
    servoRunning = false;
    smsSent = false;
    latStr = "";
    lngStr = "";
    timeStr = "";
    
    Serial.println("üíö Reset\n");
  }
  
  delay(50);
}