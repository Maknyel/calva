#include <TinyGPS++.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>

// ===== PIN DEFINITIONS =====
#define WATER_SENSOR 27
#define RELAY_PIN    26
#define SIM800_RX    16
#define SIM800_TX    17
#define GPS_RX       18
#define GPS_TX       19

// ===== WIFI =====
const char* ssid = "TestingWifi";
const char* password = "Abc1234567";

// ===== SERIAL PORTS =====
HardwareSerial sim800(1);
HardwareSerial gpsSerial(2);
TinyGPSPlus gps;

// ===== CONFIGURATION =====
String phoneNumber = "+639070653250";

// ===== LOGIC VARIABLES =====
bool triggered = false;
bool pumpRunning = false;
bool smsSent = false;
unsigned long pumpStartTime = 0;

const unsigned long PUMP_DURATION = 8500;

// ===== SIM800 RESPONSE =====
void waitForResponse(int timeout = 2000) {
  unsigned long start = millis();
  while (millis() - start < timeout) {
    while (sim800.available()) {
      Serial.write(sim800.read());
    }
  }
  Serial.println();
}

// ===== WIFI CONNECT =====
void connectWiFi() {
  if (WiFi.status() == WL_CONNECTED) return;

  Serial.print("üì° Connecting to WiFi");
  WiFi.begin(ssid, password);

  unsigned long start = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - start < 15000) {
    delay(500);
    Serial.print(".");
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\n‚úÖ WiFi connected");
  } else {
    Serial.println("\n‚ùå WiFi failed");
  }
}

// ===== GPS LOCATION =====
bool getGPSData(String &location, String &timeStr) {
  Serial.println("üìç Acquiring GPS location...");

  unsigned long start = millis();
  while (millis() - start < 30000) {
    while (gpsSerial.available()) {
      gps.encode(gpsSerial.read());
    }

    if (gps.location.isValid() && gps.satellites.value() >= 4 &&
        gps.time.isValid() && gps.date.isValid()) {

      double lat = gps.location.lat();
      double lng = gps.location.lng();
      int hour = gps.time.hour() + 8;
      if (hour >= 24) hour -= 24;

      char timeBuf[40];
      sprintf(timeBuf, "%02d/%02d/%04d %02d:%02d:%02d PHT",
              gps.date.month(), gps.date.day(), gps.date.year(),
              hour, gps.time.minute(), gps.time.second());

      location =
        String(lat, 6) + ", " + String(lng, 6) +
        "\nMaps: https://maps.google.com/?q=" +
        String(lat, 6) + "," + String(lng, 6);

      timeStr = String(timeBuf);

      Serial.println("‚úÖ GPS FIX OK");
      return true;
    }
    delay(100);
  }

  Serial.println("‚ùå GPS FIX TIMEOUT");
  return false;
}

// ===== HTTP LOCATION FALLBACK =====
bool getHttpLocation(String &location, String &timeStr) {
  if (WiFi.status() != WL_CONNECTED) return false;

  HTTPClient http;
  http.begin("https://harness.dl-hosting.net/api_location.php");

  int httpCode = http.GET();
  if (httpCode != 200) {
    http.end();
    return false;
  }

  String payload = http.getString();
  http.end();

  StaticJsonDocument<256> doc;
  if (deserializeJson(doc, payload)) return false;

  float lng = doc["longhitude"];
  float lat = doc["latitude"];
  timeStr = doc["time"].as<String>();

  location =
    String(lat, 6) + ", " + String(lng, 6) +
    "\nMaps: https://maps.google.com/?q=" +
    String(lat, 6) + "," + String(lng, 6);

  Serial.println("üåê HTTP LOCATION USED");
  return true;
}

// ===== SEND SMS =====
void sendSMS(String msg) {
  sim800.println("AT");
  waitForResponse();

  sim800.println("AT+CMGF=1");
  waitForResponse();

  sim800.println("AT+CSCS=\"IRA\"");
  waitForResponse();

  sim800.println("AT+CMGS=\"" + phoneNumber + "\"");
  delay(2000);

  sim800.print(msg);
  sim800.write(26);
}

// ===== SETUP =====
void setup() {
  pinMode(WATER_SENSOR, INPUT);
  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, HIGH);

  Serial.begin(115200);
  gpsSerial.begin(9600, SERIAL_8N1, GPS_RX, GPS_TX);
  sim800.begin(9600, SERIAL_8N1, SIM800_RX, SIM800_TX);

  connectWiFi();
  Serial.println("‚úÖ SYSTEM READY");
}

// ===== LOOP =====
void loop() {
  int waterDetected = digitalRead(WATER_SENSOR);

  if (waterDetected == HIGH && !triggered) {
    triggered = true;
    pumpRunning = true;
    pumpStartTime = millis();
    digitalWrite(RELAY_PIN, LOW);
    Serial.println("üö® WATER DETECTED ‚Äî Pump ON");
  }

  if (pumpRunning && millis() - pumpStartTime >= PUMP_DURATION) {
    pumpRunning = false;
    digitalWrite(RELAY_PIN, HIGH);
    Serial.println("üîå Pump OFF");

    String location, timeStr;

    bool gpsOK = getGPSData(location, timeStr);
    if (!gpsOK) {
      connectWiFi();
      getHttpLocation(location, timeStr);
    }

    gpsSerial.end();
    delay(300);

    String sms =
      "FLOOD ALERT!\n"
      "Status: UNSAFE\n"
      "Time: " + timeStr + "\n"
      "Location:\n" + location;

    sendSMS(sms);
    smsSent = true;
  }

  if (triggered && smsSent && waterDetected == LOW) {
    triggered = false;
    smsSent = false;
    gpsSerial.begin(9600, SERIAL_8N1, GPS_RX, GPS_TX);
    Serial.println("üíö System reset");
  }

  delay(50);
}
